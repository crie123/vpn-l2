# vpn-l2 - Layer 2 VPN Ñ Dynamic Snapshot-Based Encryption

ÐŸÑ€Ð¾Ð´Ð²Ð¸Ð½ÑƒÑ‚Ñ‹Ð¹ L2 VPN ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð¸ ÑÐµÑ€Ð²ÐµÑ€ Ð½Ð° Python Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ **teeth-gnashing** - Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð¹ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑÐ½Ð¸Ð¼ÐºÐ¾Ð² ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ (snapshots).

## ðŸ” ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸

- **Teeth-gnashing Encryption**: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð¿Ñ€Ð¾Ð´Ð²Ð¸Ð½ÑƒÑ‚Ñ‹Ð¹ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ server-client Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð¾Ð¹
- **Cross-Platform**: ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Windows (Wintun + WinDivert) Ð¸ Linux (TUN/TAP)
- **Snapshot-Based Security**: Ð¡ÐµÑ€Ð²ÐµÑ€Ð½Ñ‹Ðµ ÑÐ½Ð¸Ð¼ÐºÐ¸ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ»ÑŽÑ‡ÐµÐ¹
- **HMAC Authentication**: ÐŸÐ¾Ð´Ð¿Ð¸ÑÑŒ HMAC-SHA256 Ð´Ð»Ñ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚Ð¸
- **ChaCha20 Key Derivation**: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ChaCha20 Ð´Ð»Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð¾Ð¹ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ»ÑŽÑ‡ÐµÐ¹
- **Packet Fragmentation**: ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
- **Health Monitoring**: Ð’ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ ÑÐµÑ€Ð²ÐµÑ€Ð°

## ðŸ“‹ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°

```
vpn-l2/
â”œâ”€â”€ main.py                 # VPN ÐºÐ»Ð¸ÐµÐ½Ñ‚
â”œâ”€â”€ server_main.py          # VPN ÑÐµÑ€Ð²ÐµÑ€ (FastAPI + UDP Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº)
â”œâ”€â”€ crypto_stack.py         # ÐžÐ±Ñ‘Ñ€Ñ‚ÐºÐ° Ð´Ð»Ñ teeth-gnashing ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
â”œâ”€â”€ protocol.py             # ÐŸÑ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð» Ñ„Ñ€ÐµÐ¹Ð¼Ð¾Ð² Ð¸ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ
â”œâ”€â”€ tun.py                  # Ð˜Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ-Ð¾Ð±Ñ‘Ñ€Ñ‚ÐºÐ° Ð´Ð»Ñ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼
â”œâ”€â”€ iface_win.py            # Windows Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ (Wintun + WinDivert)
â”œâ”€â”€ iface_linux.py          # Linux Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ (TUN/TAP)
â”œâ”€â”€ client_config.json      # ÐšÐ¾Ð½Ñ„Ð¸Ð³ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸)
â”œâ”€â”€ server_config.json      # ÐšÐ¾Ð½Ñ„Ð¸Ð³ ÑÐµÑ€Ð²ÐµÑ€Ð° (Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð½Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ðµ)
â”œâ”€â”€ requirements.txt        # Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Python
â””â”€â”€ README.md              # Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð»
```

## ðŸ› ï¸ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹

### Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ
- **Python 3.8+**
- **pip** (ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð°Ð¼Ð¸)

### Windows
```bash
pip install -r requirements.txt

# Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾: Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ wintun.dll
# Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ñ https://www.wintun.net/ Ð¸ Ð¿Ð¾Ð¼ÐµÑÑ‚Ð¸Ñ‚Ðµ Ð² Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
```

### Linux
```bash
pip install -r requirements.txt

# Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹:
# sudo apt-get install iproute2 iptables python3-dev
```

## ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚

### 1ï¸âƒ£ ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº (Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¾Ð²)

ÐÐ° Ð¼Ð°ÑˆÐ¸Ð½Ðµ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð±ÑƒÐ´ÐµÑ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð¼:
```bash
python main.py
```

ÐŸÑ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐµ Ð²Ð°Ð¼ Ð±ÑƒÐ´ÑƒÑ‚ Ð·Ð°Ð´Ð°Ð½Ñ‹ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹:
- IP-Ð°Ð´Ñ€ÐµÑ VPS-ÑÐµÑ€Ð²ÐµÑ€Ð°
- SSH-Ð¿Ð¾Ñ€Ñ‚ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 22)
- Ð˜Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ SSH
- ÐŸÐ°Ñ€Ð¾Ð»ÑŒ SSH

ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸:
1. Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ `client_config.json` Ñ Ð¾Ð±Ñ‰Ð¸Ð¼ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð¼
2. Ð¡Ð¾Ð·Ð´Ð°ÑÑ‚ `server_config.json`
3. ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ Ð¿Ð¾ SSH
4. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑÑ Ðº VPN

### 2ï¸âƒ£ Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°

ÐÐ° VPS ÑÐµÑ€Ð²ÐµÑ€Ðµ (Linux/Windows):

**Linux (Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚ÑÑ Ð¿Ñ€Ð°Ð²Ð° Ñ€ÑƒÑ‚Ð°):**
```bash
sudo python server_main.py
```

**Windows (Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚ÑÑ Ð¿Ñ€Ð°Ð²Ð° Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°):**
```cmd
python server_main.py
```

Ð¡ÐµÑ€Ð²ÐµÑ€ Ð±ÑƒÐ´ÐµÑ‚:
- ÐŸÑ€Ð¾ÑÐ»ÑƒÑˆÐ¸Ð²Ð°Ñ‚ÑŒ HTTP Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 8000 (Ð´Ð»Ñ crypto snapshots)
- ÐŸÑ€Ð¾ÑÐ»ÑƒÑˆÐ¸Ð²Ð°Ñ‚ÑŒ UDP Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 5555 (Ð´Ð»Ñ VPN Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²)
- Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÑÑ… Ð¸ Ñ‚Ñ€Ð°Ñ„Ð¸ÐºÐµ

### 3ï¸âƒ£ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ

ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ ÑÐµÑ€Ð²ÐµÑ€Ð°:
```bash
curl http://localhost:8000/health
```

ÐžÑ‚Ð²ÐµÑ‚:
```json
{
  "status": "healthy",
  "timestamp": 1706794234,
  "tick": 1234,
  "authenticated_clients": 1
}
```

## ðŸ”§ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ

### client_config.json

```json
{
  "server_ip": "192.168.1.100",
  "server_http_port": 8000,
  "server_udp_ports": [5555],
  "secret_key": "base64_encoded_32_bytes",
  "max_drift": 60,
  "handshake_points": 8,
  "hash_size": 32,
  "array_size": 256,
  "platform_settings": {
    "windows": {
      "adapter_name": "vpn-l2"
    },
    "linux": {
      "interface_name": "vpn0"
    }
  }
}
```

**ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹:**
- `server_ip`: IP Ð°Ð´Ñ€ÐµÑ VPN ÑÐµÑ€Ð²ÐµÑ€Ð°
- `server_http_port`: ÐŸÐ¾Ñ€Ñ‚ FastAPI ÑÐµÑ€Ð²ÐµÑ€Ð° Ð´Ð»Ñ crypto handshake
- `server_udp_ports`: ÐŸÐ¾Ñ€Ñ‚Ñ‹ Ð´Ð»Ñ UDP VPN Ñ‚Ñ€Ð°Ñ„Ð¸ÐºÐ°
- `secret_key`: ÐžÐ±Ñ‰Ð¸Ð¹ ÑÐµÐºÑ€ÐµÑ‚ Ð² base64 (256 Ð±Ð¸Ñ‚)
- `max_drift`: ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð² ÑÐµÐºÑƒÐ½Ð´Ð°Ñ… (Ð´Ð»Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸)
- `handshake_points`: ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ñ… Ñ‚Ð¾Ñ‡ÐµÐº Ð´Ð»Ñ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
- `hash_size`: Ð Ð°Ð·Ð¼ÐµÑ€ Ñ…ÐµÑˆÐ° Ð² Ð±Ð°Ð¹Ñ‚Ð°Ñ… (Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ 32)
- `array_size`: Ð Ð°Ð·Ð¼ÐµÑ€ Ð¼Ð°ÑÑÐ¸Ð²Ð° Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ»ÑŽÑ‡ÐµÐ¹ (Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ ÐºÑ€Ð°Ñ‚Ð½Ð° 64)

### server_config.json

```json
{
  "server_ip": "0.0.0.0",
  "server_http_port": 8000,
  "server_udp_ports": [5555],
  "secret_key": "base64_encoded_32_bytes",
  "tick_interval": 1.0,
  "hash_size": 32,
  "array_size": 256,
  "platform_settings": { ... }
}
```

**ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹:**
- `server_ip`: IP Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ»ÑƒÑˆÐ¸Ð²Ð°Ð½Ð¸Ñ (0.0.0.0 = Ð²ÑÐµ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÑ‹)
- `tick_interval`: Ð˜Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ‚Ð¸ÐºÐ° Ð² ÑÐµÐºÑƒÐ½Ð´Ð°Ñ…
- ÐžÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð¼

## ðŸ” ÐšÐ°Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (teeth-gnashing)

### ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°

1. **Authentication Phase**
   - ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ 8 ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ñ… Ñ‚Ð¾Ñ‡ÐµÐº Ð² 4D Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ðµ
   - Ð¥ÐµÑˆÐ¸Ñ€ÑƒÐµÑ‚ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ñ BLAKE2b (SHA256)
   - ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ñ…ÐµÑˆ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ Ñ‡ÐµÑ€ÐµÐ· `/handshake`

2. **Snapshot Retrieval**
   - ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ ÑÐ½Ð¸Ð¼Ð¾Ðº Ñƒ ÑÐµÑ€Ð²ÐµÑ€Ð° Ñ‡ÐµÑ€ÐµÐ· `/snapshot`
   - Ð¡ÐµÑ€Ð²ÐµÑ€ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚: `tick`, `seed`, `timestamp`, `signature`
   - ÐŸÐ¾Ð´Ð¿Ð¸ÑÑŒ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ÑÑ Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ HMAC-SHA256

3. **Key Derivation**
   - Ð˜Ð· ÑÐ½Ð¸Ð¼ÐºÐ° Ð¸ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ð¹ ÑÐ¾Ð»Ð¸ (salt) Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ ÐºÐ»ÑŽÑ‡
   - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ ChaCha20 Ð´Ð»Ñ ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÑ‚Ð¾Ð¹ÐºÐ¾Ð¹ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸
   - Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ñ‚ 256 Ð±Ð°Ð¹Ñ‚ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð° ÐºÐ»ÑŽÑ‡Ð°
   - ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÑ‚ Ð² 256 Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹, Ð¸Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼Ñ‹Ñ… Ð¿Ð¾ Ð¼Ð¾Ð´ÑƒÐ»ÑŽ 256

4. **Encryption**
   - ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð±Ð°Ð¹Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑƒÐ¼Ð½Ð¾Ð¶Ð°ÐµÑ‚ÑÑ Ð½Ð° ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ð±Ð°Ð¹Ñ‚ ÐºÐ»ÑŽÑ‡Ð° Ð¿Ð¾ Ð¼Ð¾Ð´ÑƒÐ»ÑŽ 256
   - Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ÑÑ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒÐ½Ð°Ñ ÑÑƒÐ¼Ð¼Ð° BLAKE2b (32 Ð±Ð°Ð¹Ñ‚Ð°)
   - Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ÑÑ ÑÐ¾Ð»ÑŒ (32 Ð±Ð°Ð¹Ñ‚Ð°)
   - Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: `[32 Ð±Ð°Ð¹Ñ‚Ð° Ñ…ÐµÑˆÐ°][32 Ð±Ð°Ð¹Ñ‚Ð° ÑÐ¾Ð»Ð¸][Ð·Ð°ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ]`

5. **Decryption**
   - Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÑŽÑ‚ÑÑ Ñ…ÐµÑˆ, ÑÐ¾Ð»ÑŒ Ð¸ Ð·Ð°ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
   - ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ÑÑ Ñ‚Ð¾Ñ‚ Ð¶Ðµ ÑÐ½Ð¸Ð¼Ð¾Ðº ÑÐ¾ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒÑŽ, Ð·Ð°Ð²Ð¸ÑÑÑ‰ÐµÐ¹ Ð¾Ñ‚ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸
   - Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ñ‚Ð¾Ñ‚ Ð¶Ðµ ÐºÐ»ÑŽÑ‡ (Ð´ÐµÑ‚ÐµÑ€Ð¼Ð¸Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾)
   - ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð±Ð°Ð¹Ñ‚ ÑƒÐ¼Ð½Ð¾Ð¶Ð°ÐµÑ‚ÑÑ Ð½Ð° Ð¼Ð¾Ð´ÑƒÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾Ðµ ÐºÐ»ÑŽÑ‡ÐµÐ²Ð¾Ð³Ð¾ Ð±Ð°Ð¹Ñ‚Ð°
   - ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ÑÑ Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· Ñ…ÐµÑˆ

## ðŸ“Š Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²

### Frame Format
```
[1 byte: type][2 bytes: length][payload]

Type:
  0x01 = DATA (ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ)
```

### Encrypted Packet Format
```
[32 bytes: BLAKE2b hash]
[32 bytes: salt]
[N bytes: encrypted payload]
```

### Fragmentation (Ð´Ð»Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² > 1300 Ð±Ð°Ð¹Ñ‚)
```
[4 bytes: fragment_id]
[2 bytes: index]
[2 bytes: total]
[N bytes: chunk data]
```

## ðŸ–¥ï¸ ÐŸÐ»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼ÐµÐ½Ð½Ñ‹Ðµ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð¸Ñ

### Windows
- **Interface**: Wintun (Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð°Ð´Ð°Ð¿Ñ‚ÐµÑ€ Layer 3)
- **Packet Capture**: WinDivert (Ð¿ÐµÑ€ÐµÑ…Ð²Ð°Ñ‚ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²)
- **Routing**: PowerShell ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹
- **Requirements**: Administrator rights, Visual C++ Redistributable

### Linux
- **Interface**: TUN/TAP (Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Layer 3)
- **Packet Capture**: Raw sockets
- **Routing**: iproute2 ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ñ‹
- **Requirements**: Root/sudo, CAP_NET_ADMIN

## ðŸ“ˆ Troubleshooting

### ÐžÑˆÐ¸Ð±ÐºÐ°: "wintun.dll Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½" (Windows)
```bash
# Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ wintun.dll Ñ https://www.wintun.net/
# ÐŸÐ¾Ð¼ÐµÑÑ‚Ð¸Ñ‚Ðµ Ð² Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð¸Ð»Ð¸ Ð² PATH
```

### ÐžÑˆÐ¸Ð±ÐºÐ°: "Snapshot expired or too far in future"
```bash
# Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð¼ÐµÐ¶Ð´Ñƒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð¼ Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð¼
# Ð£Ð²ÐµÐ»Ð¸Ñ‡ÑŒÑ‚Ðµ max_drift Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³Ðµ, ÐµÑÐ»Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾
ntpdate -s time.nist.gov  # Linux
# Ð¸Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Windows Time Service
```

### ÐžÑˆÐ¸Ð±ÐºÐ°: "Authentication failed"
```bash
# Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ secret_key Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ‡ÐµÐ½ Ð½Ð° Ð¾Ð±Ð¾Ð¸Ñ… Ð¼Ð°ÑˆÐ¸Ð½Ð°Ñ…
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ ÑÐµÑ€Ð²ÐµÑ€Ð°: curl http://server:8000/health
```

### ÐžÑˆÐ¸Ð±ÐºÐ°: "Hash mismatch! Possible tampering"
```bash
# ÐŸÐ°ÐºÐµÑ‚ Ð±Ñ‹Ð» Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´Ñ‘Ð½ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ðµ
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ Ð¸ NAT/firewall Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
```

### ÐÐ¸Ð·ÐºÐ°Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ
```bash
# Ð£Ð²ÐµÐ»Ð¸Ñ‡ÑŒÑ‚Ðµ array_size Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³Ðµ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 512, 1024)
# Ð£Ð¼ÐµÐ½ÑŒÑˆÐ¸Ñ‚Ðµ hash_size ÐµÑÐ»Ð¸ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ (Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 16)
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ½ÑƒÑŽ ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚ÑŒ ÑÐµÑ‚Ð¸
```

## ðŸ“š API Endpoints (Crypto Server)

### POST /handshake
ÐÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
```bash
curl -X POST http://localhost:8000/handshake \
  -H "Content-Type: application/json" \
  -d '{"hash": "abcd1234..."}'
```

Response:
```json
{"status": "ok"}
```

### GET /snapshot
ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ½Ð¸Ð¼Ð¾Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ»ÑŽÑ‡ÐµÐ¹
```bash
curl http://localhost:8000/snapshot
```

Response:
```json
{
  "tick": 42,
  "seed": 987654321,
  "timestamp": 1706794234,
  "signature": "base64_signature"
}
```

### GET /health
ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ ÑÐµÑ€Ð²ÐµÑ€Ð°
```bash
curl http://localhost:8000/health
```

Response:
```json
{
  "status": "healthy",
  "timestamp": 1706794234,
  "tick": 42,
  "authenticated_clients": 3
}
```

## ðŸ”„ Ð–Ð¸Ð·Ð½ÐµÐ½Ð½Ñ‹Ð¹ Ñ†Ð¸ÐºÐ» ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ

```
CLIENT                          SERVER
  |                               |
  |-------- /handshake --------->|
  |<-------- ok/reject -----------|
  |                               |
  |-------- /snapshot ---------->|
  |<------ tick+seed+sig ---------|
  |                               |
  | [Derive key from snapshot]   |
  | [Encrypt packet]             |
  |                               |
  |-------- UDP packet --------->|
  |                      [Receive packet]
  |                      [Attempt decrypt]
  |                               |
  |<------- UDP response ---------|
  | [Receive response]            |
  | [Decrypt with new snapshot]   |
  |                               |
  |-------- /snapshot ---------->|
  |<------ new tick+seed+sig-----|
  |                               |
  ... (repeat for each packet)
```

## ðŸ›¡ï¸ ÐšÑ€Ð¸Ð¿Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ñ

- **HMAC-SHA256**: Ð”Ð»Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸ ÑÐ½Ð¸Ð¼ÐºÐ¾Ð²
- **BLAKE2b**: Ð”Ð»Ñ Ñ…ÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ (256 Ð¸Ð»Ð¸ 512 Ð±Ð¸Ñ‚)
- **ChaCha20**: Ð”Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð° ÐºÐ»ÑŽÑ‡ÐµÐ¹
- **Modular arithmetic (mod 256)**: Ð”Ð»Ñ ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ/Ð´ÐµÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ

**Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ:**
- ÐšÐ»ÑŽÑ‡Ð¸ Ñ€ÐµÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¿Ð°ÐºÐµÑ‚Ð°
- ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð°ÐºÐµÑ‚ Ð¸Ð¼ÐµÐµÑ‚ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ ÑÐ¾Ð»ÑŒ
- ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒÐ½Ñ‹Ðµ ÑÑƒÐ¼Ð¼Ñ‹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÑŽÑ‚ Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ
- Ð’Ñ€ÐµÐ¼Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð¼ÐµÐ¶Ð´Ñƒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð¼ Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð¼

## ðŸ“ Ð›Ð¸Ñ†ÐµÐ½Ð·Ð¸Ñ

GNU General Public License v2.0 - ÑÐ¼. LICENSE Ñ„Ð°Ð¹Ð»

## ðŸ‘¨â€ðŸ’» ÐÐ²Ñ‚Ð¾Ñ€

Kirill Nikitenko

## ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ¸

- [teeth-gnashing PyPI](https://pypi.org/project/teeth-gnashing/)
- [Wintun](https://www.wintun.net/)
- [FastAPI](https://fastapi.tiangolo.com/)
- [Paramiko SSH](https://www.paramiko.org/)
